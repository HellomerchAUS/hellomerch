<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hello Merch â€“ Commission Tracker</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0a; --surface: #111; --surface2: #161616; --border: #222;
    --accent: #e8ff47; --green: #4fffb0; --blue: #47c9ff; --orange: #ffb347;
    --red: #ff6b47; --text: #f0f0f0; --muted: #555;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; font-size: 14px; }

  /* HEADER */
  header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 16px 28px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
  .logo { font-family: 'Bebas Neue', sans-serif; font-size: 26px; letter-spacing: 3px; color: var(--accent); }
  .logo span { color: var(--text); }
  .logo-sub { color: var(--muted); font-size: 13px; letter-spacing: 1px; margin-left: 8px; }
  .header-right { display: flex; align-items: center; gap: 10px; }
  .sync-indicator { font-size: 12px; color: var(--muted); }
  .sync-indicator.syncing { color: var(--orange); }
  .sync-indicator.error { color: var(--red); }

  /* LAYOUT */
  .container { max-width: 1400px; margin: 0 auto; padding: 24px; }

  /* SELECT / INPUTS */
  select, input { background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 9px 12px; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 13px; outline: none; width: 100%; }
  select:focus, input:focus { border-color: var(--accent); }
  input::placeholder { color: var(--muted); }

  /* BUTTONS */
  .btn { background: var(--accent); color: #000; border: none; padding: 9px 22px; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 13px; cursor: pointer; transition: opacity 0.15s; white-space: nowrap; }
  .btn:hover { opacity: 0.85; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-sm { background: var(--surface2); color: var(--text); border: 1px solid var(--border); padding: 5px 12px; border-radius: 5px; font-family: 'DM Sans', sans-serif; font-size: 11px; cursor: pointer; }
  .btn-danger { background: var(--surface2); color: var(--red); border: 1px solid var(--border); padding: 5px 10px; border-radius: 4px; font-family: 'DM Sans', sans-serif; font-size: 11px; cursor: pointer; }

  /* TABS */
  .tabs { display: flex; gap: 4px; margin-bottom: 24px; border-bottom: 1px solid var(--border); }
  .tab { padding: 10px 20px; background: none; border: none; color: var(--muted); font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 500; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.15s; }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab:hover:not(.active) { color: var(--text); }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* CARDS */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 20px; margin-bottom: 16px; }
  .card-accent { background: rgba(232,255,71,0.04); border: 1px solid rgba(232,255,71,0.25); border-radius: 10px; padding: 20px; }
  .card-green  { background: rgba(79,255,176,0.04); border: 1px solid rgba(79,255,176,0.25); border-radius: 10px; padding: 20px; }
  .card-blue   { background: rgba(71,201,255,0.04); border: 1px solid rgba(71,201,255,0.25); border-radius: 10px; padding: 20px; }

  /* STAT */
  .stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--muted); margin-bottom: 6px; }
  .stat-val { font-family: 'Bebas Neue', sans-serif; font-size: 36px; letter-spacing: 1px; line-height: 1; }
  .stat-sub { font-size: 11px; color: var(--muted); margin-top: 4px; }

  /* GRID */
  .grid-4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 14px; margin-bottom: 20px; }
  .grid-3 { display: grid; grid-template-columns: repeat(3,1fr); gap: 14px; margin-bottom: 14px; }
  .grid-2 { display: grid; grid-template-columns: repeat(2,1fr); gap: 14px; }
  @media(max-width:900px) { .grid-4,.grid-3 { grid-template-columns: repeat(2,1fr); } }
  @media(max-width:600px) { .grid-4,.grid-3,.grid-2 { grid-template-columns: 1fr; } }

  /* SECTION TITLE */
  .section-title { font-family: 'Bebas Neue', sans-serif; font-size: 15px; letter-spacing: 2px; color: var(--muted); margin-bottom: 12px; }

  /* TABLE */
  .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; margin-bottom: 20px; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; min-width: 600px; }
  thead tr { background: var(--surface2); }
  th { padding: 10px 14px; text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--muted); font-weight: 500; white-space: nowrap; }
  td { padding: 12px 14px; border-top: 1px solid #1e1e1e; font-size: 13px; vertical-align: middle; }
  tr:hover td { background: rgba(255,255,255,0.015); }

  /* BADGES */
  .badge { display: inline-block; padding: 3px 9px; border-radius: 100px; font-size: 11px; font-weight: 600; }
  .badge-new         { color: var(--accent);  background: rgba(232,255,71,0.12); }
  .badge-repeat      { color: var(--blue);    background: rgba(71,201,255,0.12); }
  .badge-reactivated { color: var(--orange);  background: rgba(255,179,71,0.12); }
  .badge-eligible    { color: var(--green);   background: rgba(79,255,176,0.12); }
  .badge-ineligible  { color: var(--red);     background: rgba(255,107,71,0.12); }

  /* PROGRESS */
  .progress-hero { background: linear-gradient(135deg,#1a1a00,#001a1a); border: 1px solid var(--border); border-radius: 12px; padding: 28px; margin-bottom: 20px; position: relative; overflow: hidden; }
  .progress-hero::before { content:''; position:absolute; top:-40px; right:-40px; width:200px; height:200px; background: radial-gradient(circle,rgba(232,255,71,0.07) 0%,transparent 70%); }
  .progress-track { background: #222; border-radius: 100px; height: 12px; overflow: hidden; margin-bottom: 10px; }
  .progress-fill { height: 100%; border-radius: 100px; transition: width 0.6s cubic-bezier(0.34,1.56,0.64,1); min-width: 4px; }
  .progress-fill.below { background: linear-gradient(90deg, var(--blue), var(--accent)); }
  .progress-fill.above { background: linear-gradient(90deg, var(--accent), var(--green)); }
  .threshold-msg { padding: 11px 16px; border-radius: 8px; font-size: 13px; font-weight: 500; margin-top: 10px; }
  .threshold-msg.hit  { background: rgba(79,255,176,0.1);  border: 1px solid rgba(79,255,176,0.2);  color: var(--green); }
  .threshold-msg.miss { background: rgba(255,107,71,0.1);  border: 1px solid rgba(255,107,71,0.2);  color: var(--orange); }

  /* PAYOUT CARD */
  .payout-card { background: var(--surface); border: 2px solid var(--accent); border-radius: 12px; padding: 28px; margin-bottom: 16px; }
  .payout-line { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
  .payout-line:last-of-type { border-bottom: none; }
  .payout-total { display: flex; justify-content: space-between; padding-top: 18px; font-family: 'Bebas Neue', sans-serif; font-size: 32px; letter-spacing: 1px; color: var(--accent); }

  /* FORM */
  .form-label { display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); margin-bottom: 5px; }
  .form-msg { font-size: 13px; }
  .form-msg.ok  { color: var(--green); }
  .form-msg.err { color: var(--red); }

  /* MONTH SELECT (header) */
  .month-select { background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 8px 12px; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 13px; outline: none; cursor: pointer; width: auto; }

  /* NO DATA */
  .no-data { text-align: center; padding: 40px; color: #444; font-size: 13px; }

  /* LOADING */
  .loading-screen { display: flex; align-items: center; justify-content: center; min-height: 60vh; flex-direction: column; gap: 12px; }
  .loading-screen .title { font-family: 'Bebas Neue', sans-serif; font-size: 32px; color: var(--accent); letter-spacing: 3px; }
  .loading-screen .sub { color: var(--muted); font-size: 13px; }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div>
    <span class="logo">HELLO<span>MERCH</span></span>
    <span class="logo-sub">/ COMMISSION TRACKER</span>
  </div>
  <div class="header-right">
    <span class="sync-indicator" id="syncStatus">â—  Live</span>
    <select class="month-select" id="monthSelector"></select>
  </div>
</header>

<!-- MAIN -->
<div class="container" id="app">
  <div class="loading-screen">
    <div class="title">LOADING...</div>
    <div class="sub">Connecting to Airtable</div>
  </div>
</div>

<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// IMPORTANT: Airtable credentials are handled server-side via a Netlify Function.
// Set these in Netlify â†’ Site settings â†’ Environment variables:
//   AT_TOKEN, AT_BASE, AT_TABLE
// Frontend calls:
const FN_URL = '/.netlify/functions/airtable';

// â”€â”€â”€ COMMISSION CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const THRESHOLD     = 15000;   // ex-GST
const THRESHOLD_INC = 16500;   // inc-GST (display only)
const TIERS = [
  { min:1000,  max:4999,   rate:0.02 },
  { min:5000,  max:9999,   rate:0.03 },
  { min:10000, max:24999,  rate:0.04 },
  { min:25000, max:49999,  rate:0.05 },
  { min:50000, max:74999,  rate:0.06 },
  { min:75000, max:100000, rate:0.07 },
];

// â”€â”€â”€ COMMISSION LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getCommRate(rev) {
  for (const t of TIERS) if (rev >= t.min && rev <= t.max) return t.rate;
  if (rev > 100000) return 0.07;
  return 0;
}
function getMarginKicker(m) {
  if (m >= 55) return 0.015;
  if (m >= 50) return 0.010;
  if (m >= 45) return 0.005;
  return 0;
}
function isEligible(job) {
  if (job.revenue < 1000) return { ok:false, reason:'Rev < $1,000' };
  if (job.margin < 40)    return { ok:false, reason:'Margin < 40%' };
  return { ok:true, reason:'Eligible' };
}
function calcJobComm(job, aboveThreshold) {
  const e = isEligible(job);
  if (!e.ok) return { commission:0, rate:0, reason:e.reason };
  if (job.type === 'repeat') return { commission:job.revenue*0.01, rate:0.01, reason:'Repeat 1%' };
  if (!aboveThreshold) return { commission:0, rate:0, reason:'Below $15k threshold' };
  const base   = getCommRate(job.revenue);
  const kicker = getMarginKicker(job.margin);
  const total  = base + kicker;
  const mult   = job.type === 'reactivated' ? 0.5 : 1;
  const label  = job.type === 'reactivated'
    ? `Reactivated ${(total*100).toFixed(1)}%Ã—50%`
    : `${(total*100).toFixed(1)}%`;
  return { commission: job.revenue * total * mult, rate: total * mult, reason: label };
}
function calcMonth(monthKey, jobs) {
  const mj     = jobs.filter(j => j.date && j.date.startsWith(monthKey));
  const newRev = mj.filter(j => j.type !== 'repeat' && isEligible(j).ok).reduce((s,j)=>s+j.revenue,0);
  const above  = newRev >= THRESHOLD;
  let base = 0, repeat = 0;
  for (const j of mj) {
    const r = calcJobComm(j, above);
    if (j.type === 'repeat') repeat += r.commission;
    else base += r.commission;
  }
  return { mj, newRev, above, commRev: above ? newRev-THRESHOLD : 0, base, repeat };
}
function getQuarterKey(mk) {
  const [y,m] = mk.split('-').map(Number);
  return `${y}-Q${Math.ceil(m/3)}`;
}
function getQuarterMonths(qk) {
  const [y,q] = qk.split('-Q').map(Number);
  const s = (q-1)*3+1;
  return [s,s+1,s+2].map(m=>`${y}-${String(m).padStart(2,'0')}`);
}
function calcQuarter(qk, jobs) {
  const months  = getQuarterMonths(qk);
  const qj      = jobs.filter(j => months.some(m => j.date && j.date.startsWith(m)));
  const newRev  = qj.filter(j => j.type !== 'repeat' && isEligible(j).ok).reduce((s,j)=>s+j.revenue,0);
  const elig    = qj.filter(j => isEligible(j).ok && j.type !== 'repeat');
  const avgMargin = elig.length ? elig.reduce((s,j)=>s+j.margin,0)/elig.length : 0;
  let bonus = 0;
  if (avgMargin >= 38) {
    if (newRev >= 200000) bonus = 5000;
    else if (newRev >= 100000) bonus = 2000;
  }
  return { bonus, newRev, avgMargin };
}

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
function monthLabel(k) { const [y,m]=k.split('-'); return `${MONTHS[+m-1]} ${y}`; }
function currentMK()   { const n=new Date(); return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}`; }
function fmt(n)        { return '$'+Number(n||0).toLocaleString('en-AU',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmtPct(n)     { return (n*100).toFixed(1)+'%'; }
function todayStr()    { return new Date().toISOString().split('T')[0]; }
function badge(type)   { return `<span class="badge badge-${type}">${type}</span>`; }

// â”€â”€â”€ AIRTABLE API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchJobs() {
  setSyncStatus('syncing', 'â†»  Syncing');
  try {
    const res = await fetch(`${FN_URL}?op=list`, { headers: { 'Content-Type': 'application/json' } });
    const data = await res.json();
    if (!res.ok) throw new Error(data?.error || 'Failed to fetch jobs');
    setSyncStatus('live', 'â—  Live');
    return data.jobs || [];
  } catch (e) {
    setSyncStatus('error', 'âœ•  Error');
    console.error(e);
    return null;
  }
}


async function addJobAirtable(job) {
  const res = await fetch(`${FN_URL}?op=add`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ job })
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data?.error || 'Failed to add job');
  return data.job;
}


async function deleteJobAirtable(id) {
  const res = await fetch(`${FN_URL}?op=delete&id=${encodeURIComponent(id)}`, {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' }
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data?.error || 'Failed to delete job');
}


function setSyncStatus(state, text) {
  const el = document.getElementById('syncStatus');
  if (!el) return;
  el.textContent = text;
  el.className = 'sync-indicator' + (state !== 'live' ? ` ${state}` : '');
}

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let jobs = [];
let selectedMonth = currentMK();
let activeTab = 'nikki';

// â”€â”€â”€ MONTH SELECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildMonthOptions() {
  const sel = document.getElementById('monthSelector');
  if (!sel) return;
  const keys = [...new Set(jobs.map(j => j.date ? j.date.substring(0,7) : null).filter(Boolean))];
  const now  = new Date();
  for (let i=-1; i<=3; i++) {
    const d = new Date(now.getFullYear(), now.getMonth()+i, 1);
    const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    if (!keys.includes(k)) keys.push(k);
  }
  keys.sort().reverse();
  sel.innerHTML = keys.map(k=>`<option value="${k}"${k===selectedMonth?' selected':''}>${monthLabel(k)}</option>`).join('');
  sel.onchange = e => { selectedMonth = e.target.value; renderApp(); };
}

// â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderApp() {
  buildMonthOptions();
  const app = document.getElementById('app');
  app.innerHTML = `
    <div class="tabs">
      ${[['nikki','ğŸ¯ Nikki'],['owner','ğŸ“Š Owner'],['bookkeeper','ğŸ’° Bookkeeper'],['jobs','+ Add Jobs']].map(([id,label])=>
        `<button class="tab${activeTab===id?' active':''}" onclick="switchTab('${id}')">${label}</button>`
      ).join('')}
    </div>
    <div id="tab-nikki"       class="tab-panel${activeTab==='nikki'?' active':''}">      ${renderNikki()}       </div>
    <div id="tab-owner"       class="tab-panel${activeTab==='owner'?' active':''}">      ${renderOwner()}       </div>
    <div id="tab-bookkeeper"  class="tab-panel${activeTab==='bookkeeper'?' active':''}"> ${renderBookkeeper()}  </div>
    <div id="tab-jobs"        class="tab-panel${activeTab==='jobs'?' active':''}">       ${renderJobs()}        </div>
  `;
  // re-bind form
  const addBtn = document.getElementById('addJobBtn');
  if (addBtn) addBtn.onclick = submitJob;
}

function switchTab(id) {
  activeTab = id;
  renderApp();
}

// â”€â”€â”€ NIKKI TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderNikki() {
  const s   = calcMonth(selectedMonth, jobs);
  const pct = Math.min((s.newRev/THRESHOLD)*100,100);
  const left = Math.max(THRESHOLD-s.newRev,0);
  const qk  = getQuarterKey(selectedMonth);
  const qd  = calcQuarter(qk, jobs);
  const qms = getQuarterMonths(qk);

  return `
    <div class="progress-hero">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:2px;color:var(--muted);margin-bottom:4px">COMMISSION TERRITORY</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:2px;line-height:1;margin-bottom:20px">${monthLabel(selectedMonth).toUpperCase()}</div>
      <div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:12px">
        <span style="color:var(--accent);font-weight:600;font-size:18px">${fmt(s.newRev)} <span style="font-size:12px;color:#666;font-weight:400">ex-GST</span></span>
        <span style="color:var(--muted);text-align:right">Threshold: <strong style="color:#888">${fmt(THRESHOLD)} ex-GST</strong> <span style="color:#444">(${fmt(THRESHOLD_INC)} inc-GST)</span></span>
      </div>
      <div class="progress-track"><div class="progress-fill ${s.above?'above':'below'}" style="width:${pct}%"></div></div>
      <div class="threshold-msg ${s.above?'hit':'miss'}">
        ${s.above
          ? `ğŸ‰ Threshold hit! You're in commission territory.`
          : `You need <strong>${fmt(left)} ex-GST</strong> (${fmt(left*1.1)} inc-GST) more to unlock commission this month.`}
      </div>
    </div>

    <div class="grid-4">
      <div class="card-accent">
        <div class="stat-label">Commission Earned</div>
        <div class="stat-val" style="color:var(--accent)">${fmt(s.base+s.repeat)}</div>
        <div class="stat-sub">This month total</div>
      </div>
      <div class="card-green">
        <div class="stat-label">Commissionable Rev</div>
        <div class="stat-val" style="color:var(--green)">${fmt(s.commRev)}</div>
        <div class="stat-sub">Above $15k ex-GST</div>
      </div>
      <div class="card-blue">
        <div class="stat-label">Jobs This Month</div>
        <div class="stat-val" style="color:var(--blue)">${s.mj.length}</div>
        <div class="stat-sub">All types</div>
      </div>
      <div class="card">
        <div class="stat-label">Repeat Bonus</div>
        <div class="stat-val">${fmt(s.repeat)}</div>
        <div class="stat-sub">1% on eligible repeats</div>
      </div>
    </div>

    <div class="section-title">THIS MONTH'S JOBS</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Client</th><th>Type</th><th>Revenue</th><th>Margin</th><th>Eligible</th><th>Rate</th><th>Commission</th><th>Date</th></tr></thead>
        <tbody>
          ${s.mj.length===0
            ? `<tr><td colspan="8" class="no-data">No jobs this month. Go to "+ Add Jobs" to add one.</td></tr>`
            : s.mj.map(job=>{
                const e=isEligible(job); const r=calcJobComm(job,s.above);
                return `<tr>
                  <td>${job.client}</td>
                  <td>${badge(job.type)}</td>
                  <td>${fmt(job.revenue)}</td>
                  <td>${job.margin}%</td>
                  <td>${badge(e.ok?'eligible':'ineligible')} <span style="font-size:11px;color:var(--muted)">${e.reason}</span></td>
                  <td>${r.rate>0?fmtPct(r.rate):'â€”'}</td>
                  <td style="font-weight:600;color:${r.commission>0?'var(--green)':'#444'}">${fmt(r.commission)}</td>
                  <td style="color:var(--muted);font-size:12px">${job.date}</td>
                </tr>`;
              }).join('')}
        </tbody>
      </table>
    </div>

    <div class="section-title">QUARTERLY ACCELERATOR â€” ${qk}</div>
    <div class="grid-4">
      <div class="card">
        <div class="stat-label">Quarter Months</div>
        <div style="font-size:12px;color:#888;line-height:2">${qms.map(monthLabel).join('<br>')}</div>
      </div>
      <div class="card-blue">
        <div class="stat-label">Quarter New Revenue</div>
        <div class="stat-val" style="color:var(--blue)">${fmt(qd.newRev)}</div>
        <div class="stat-sub">$100k â†’ $2,000 | $200k â†’ $5,000</div>
      </div>
      <div class="card">
        <div class="stat-label">Avg Margin (need â‰¥38%)</div>
        <div class="stat-val" style="color:${qd.avgMargin>=38?'var(--green)':'var(--red)'}">${qd.avgMargin.toFixed(1)}%</div>
        <div class="stat-sub">${qd.avgMargin>=38?'âœ“ Qualifies':'âœ— Below minimum'}</div>
      </div>
      <div class="card-accent">
        <div class="stat-label">Quarterly Bonus</div>
        <div class="stat-val" style="color:var(--accent)">${fmt(qd.bonus)}</div>
        <div class="stat-sub">${qd.newRev>=200000?'ğŸ† $200k tier!':qd.newRev>=100000?'âœ“ $100k tier':`Need ${fmt(100000-qd.newRev)} more`}</div>
      </div>
    </div>
  `;
}

// â”€â”€â”€ OWNER TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOwner() {
  const allMK = [...new Set(jobs.map(j=>j.date?j.date.substring(0,7):null).filter(Boolean))].sort();
  let ltRev=0, ltComm=0;
  const rows = allMK.map(mk=>{
    const s  = calcMonth(mk,jobs);
    const qk = getQuarterKey(mk);
    const qMs = getQuarterMonths(qk);
    const isLastQ = qMs[2]===mk;
    const qb = isLastQ ? calcQuarter(qk,jobs).bonus : 0;
    const total = s.base+s.repeat+qb;
    ltRev  += s.newRev;
    ltComm += total;
    return { mk, s, qb, total };
  });

  return `
    <div class="section-title">NIKKI â€” LIFETIME PERFORMANCE</div>
    <div class="grid-4" style="margin-bottom:28px">
      <div class="card-accent" style="padding:24px">
        <div class="stat-label">Lifetime Revenue</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:42px;letter-spacing:1px;color:var(--accent)">${fmt(ltRev)}</div>
        <div class="stat-sub">All new business brought in</div>
      </div>
      <div class="card-green" style="padding:24px">
        <div class="stat-label">Lifetime Commission</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:42px;letter-spacing:1px;color:var(--green)">${fmt(ltComm)}</div>
        <div class="stat-sub">Total paid / due</div>
      </div>
      <div class="card-blue" style="padding:24px">
        <div class="stat-label">Effective Rate</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:42px;letter-spacing:1px;color:var(--blue)">${ltRev>0?fmtPct(ltComm/ltRev):'0%'}</div>
        <div class="stat-sub">Commission / Revenue</div>
      </div>
      <div class="card" style="padding:24px">
        <div class="stat-label">Active Months</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:42px;letter-spacing:1px">${allMK.length}</div>
        <div class="stat-sub">Months with jobs</div>
      </div>
    </div>

    <div class="section-title">MONTHLY HISTORY</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Month</th><th>Jobs</th><th>New Revenue</th><th>Commissionable</th><th>Base Comm</th><th>Repeat</th><th>Qtr Bonus</th><th>Total</th><th>Rate</th></tr></thead>
        <tbody>
          ${rows.length===0
            ? `<tr><td colspan="9" class="no-data">No data yet.</td></tr>`
            : [...rows].reverse().map(({mk,s,qb,total})=>`<tr>
                <td>${monthLabel(mk)}</td>
                <td>${s.mj.length}</td>
                <td>${fmt(s.newRev)}</td>
                <td>${fmt(s.commRev)}</td>
                <td>${fmt(s.base)}</td>
                <td>${fmt(s.repeat)}</td>
                <td>${fmt(qb)}</td>
                <td style="font-weight:700;color:${total>0?'var(--green)':'#444'}">${fmt(total)}</td>
                <td style="color:var(--muted)">${s.newRev>0?fmtPct(total/s.newRev):'â€”'}</td>
              </tr>`).join('')}
        </tbody>
      </table>
    </div>
  `;
}

// â”€â”€â”€ BOOKKEEPER TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBookkeeper() {
  const [y,m] = selectedMonth.split('-').map(Number);
  const pd    = new Date(y,m-2,1);
  const prevMK = `${pd.getFullYear()}-${String(pd.getMonth()+1).padStart(2,'0')}`;
  const s     = calcMonth(prevMK,jobs);
  const qk    = getQuarterKey(prevMK);
  const qMs   = getQuarterMonths(qk);
  const isLastQ = qMs[2]===prevMK;
  const qb    = isLastQ ? calcQuarter(qk,jobs).bonus : 0;
  const total = s.base+s.repeat+qb;
  const commJobs = s.mj.filter(j=>calcJobComm(j,s.above).commission>0);

  const lines = [
    ['Period', monthLabel(prevMK)],
    ['Total New Revenue (ex-GST)', fmt(s.newRev)],
    [`Threshold (ex-GST / inc-GST)`, `${fmt(THRESHOLD)} / ${fmt(THRESHOLD_INC)}`],
    ['Threshold Met?', s.above ? 'âœ“ Yes' : 'âœ— No â€“ no base commission payable'],
    ['Base Commission', fmt(s.base)],
    ['Repeat Order Bonus', fmt(s.repeat)],
    [`Quarterly Bonus (${isLastQ?qk:'not end of quarter'})`, fmt(qb)],
  ];

  return `
    <div class="payout-card">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;color:var(--accent);margin-bottom:20px">
        COMMISSION PAYOUT â€” ${monthLabel(prevMK).toUpperCase()}
      </div>
      ${lines.map(([label,val])=>`
        <div class="payout-line">
          <span style="color:var(--muted)">${label}</span>
          <span style="font-weight:600;color:${label.includes('Met') ? (s.above?'var(--green)':'var(--red)') : 'var(--text)'}">${val}</span>
        </div>`).join('')}
      <div class="payout-total">
        <span>TOTAL DUE TO NIKKI</span>
        <span>${fmt(total)}</span>
      </div>
    </div>

    <div style="color:var(--muted);font-size:12px;margin-bottom:20px">
      âš ï¸ Per policy: commission paid 1 month in arrears. Amount above covers jobs in
      <strong style="color:#888">${monthLabel(prevMK)}</strong>, payable during ${monthLabel(selectedMonth)}.
    </div>

    <div class="section-title">JOB BREAKDOWN</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Client</th><th>Type</th><th>Revenue</th><th>Margin</th><th>Rate</th><th>Commission</th><th>Notes</th></tr></thead>
        <tbody>
          ${commJobs.length===0
            ? `<tr><td colspan="7" class="no-data">No commissionable jobs for ${monthLabel(prevMK)}.</td></tr>`
            : commJobs.map(j=>{
                const r=calcJobComm(j,s.above);
                return `<tr>
                  <td>${j.client}</td>
                  <td>${badge(j.type)}</td>
                  <td>${fmt(j.revenue)}</td>
                  <td>${j.margin}%</td>
                  <td>${fmtPct(r.rate)}</td>
                  <td style="font-weight:700;color:var(--green)">${fmt(r.commission)}</td>
                  <td style="color:var(--muted);font-size:12px">${r.reason}${j.notes?' | '+j.notes:''}</td>
                </tr>`;
              }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

// â”€â”€â”€ ADD JOBS TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderJobs() {
  const s = calcMonth(selectedMonth, jobs);
  return `
    <div class="card">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;margin-bottom:18px">ADD NEW JOB</div>
      <div class="grid-3">
        <div>
          <label class="form-label">Client Name</label>
          <input id="fClient" type="text" placeholder="e.g. Surf Co Noosa">
        </div>
        <div>
          <label class="form-label">Job Revenue ($ ex-GST)</label>
          <input id="fRevenue" type="number" placeholder="e.g. 2500" min="0" step="0.01">
        </div>
        <div>
          <label class="form-label">Gross Margin (%)</label>
          <input id="fMargin" type="number" placeholder="e.g. 45" min="0" max="100" step="0.1">
        </div>
        <div>
          <label class="form-label">Job Type</label>
          <select id="fType">
            <option value="new">New Client</option>
            <option value="repeat">Repeat Order (within 6mo)</option>
            <option value="reactivated">Reactivated (36mo+)</option>
          </select>
        </div>
        <div>
          <label class="form-label">Date</label>
          <input id="fDate" type="date" value="${todayStr()}">
        </div>
        <div>
          <label class="form-label">Notes (optional)</label>
          <input id="fNotes" type="text" placeholder="e.g. referral from X">
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:14px;margin-top:4px">
        <button class="btn" id="addJobBtn">+ Add Job</button>
        <span id="jobMsg" class="form-msg"></span>
      </div>
    </div>

    <div class="section-title">JOBS â€” ${monthLabel(selectedMonth).toUpperCase()}</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Client</th><th>Type</th><th>Revenue</th><th>Margin</th><th>Date</th><th>Notes</th><th>Eligible</th><th>Commission</th><th></th></tr></thead>
        <tbody>
          ${s.mj.length===0
            ? `<tr><td colspan="9" class="no-data">No jobs this month yet.</td></tr>`
            : s.mj.map(job=>{
                const e=isEligible(job); const r=calcJobComm(job,s.above);
                return `<tr>
                  <td>${job.client}</td>
                  <td>${badge(job.type)}</td>
                  <td>${fmt(job.revenue)}</td>
                  <td>${job.margin}%</td>
                  <td style="color:var(--muted);font-size:12px">${job.date}</td>
                  <td style="color:var(--muted);font-size:12px">${job.notes||'â€”'}</td>
                  <td>${badge(e.ok?'eligible':'ineligible')}</td>
                  <td style="font-weight:600;color:${r.commission>0?'var(--green)':'#444'}">${fmt(r.commission)}</td>
                  <td><button class="btn-danger" onclick="deleteJob('${job.id}')">Delete</button></td>
                </tr>`;
              }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

// â”€â”€â”€ SUBMIT JOB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitJob() {
  const client  = document.getElementById('fClient')?.value.trim();
  const revenue = parseFloat(document.getElementById('fRevenue')?.value);
  const margin  = parseFloat(document.getElementById('fMargin')?.value);
  const type    = document.getElementById('fType')?.value;
  const date    = document.getElementById('fDate')?.value || todayStr();
  const notes   = document.getElementById('fNotes')?.value.trim() || '';
  const msgEl   = document.getElementById('jobMsg');

  const setMsg = (text,ok) => { if(msgEl){msgEl.textContent=text;msgEl.className='form-msg '+(ok?'ok':'err');} };

  if (!client)              { setMsg('Enter a client name',false); return; }
  if (isNaN(revenue)||revenue<=0) { setMsg('Enter a valid revenue',false); return; }
  if (isNaN(margin)||margin<0||margin>100) { setMsg('Enter a valid margin %',false); return; }

  const btn = document.getElementById('addJobBtn');
  if(btn) { btn.disabled=true; btn.textContent='Savingâ€¦'; }
  setMsg('','ok');

  try {
    const newJob = await addJobAirtable({ client, revenue, margin, type, date, notes });
    jobs.push(newJob);
    setMsg(`âœ“ Job added for ${client}`, true);
    renderApp();
    // switch to nikki tab to show updated progress
    setTimeout(()=>{ activeTab='jobs'; renderApp(); },100);
  } catch(e) {
    setMsg('Error saving â€” check connection', false);
    if(btn) { btn.disabled=false; btn.textContent='+ Add Job'; }
  }
}

// â”€â”€â”€ DELETE JOB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function deleteJob(id) {
  if (!confirm('Delete this job?')) return;
  try {
    await deleteJobAirtable(id);
    jobs = jobs.filter(j=>j.id!==id);
    renderApp();
  } catch(e) {
    alert('Error deleting job. Please try again.');
  }
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  const data = await fetchJobs();
  if (data === null) {
    document.getElementById('app').innerHTML = `
      <div class="loading-screen">
        <div class="title" style="color:var(--red)">CONNECTION ERROR</div>
        <div class="sub">Could not reach Airtable. Check your internet connection and refresh.</div>
      </div>`;
    return;
  }
  jobs = data;
  renderApp();

  // Auto-refresh every 30 seconds
  setInterval(async () => {
    const fresh = await fetchJobs();
    if (fresh !== null) { jobs = fresh; renderApp(); }
  }, 30000);
}

init();
</script>
</body>
</html>
